# PocketAdmin  
  
Это устройство для программного ввода клавиш (также называется badusb). Оно похоже на  
известное устройство [USB rubber ducky](https://shop.hak5.org/products/usb-rubber-ducky-deluxe), сделанное командой Hak5, при этом имеет широкие  
возможности, меньшую цену и полностью открытые исходные файлы. Оно выглядит как самый  
обычный USB диск, но при этом работает как клавиатура, которая исполняет заранее записанную  
серию команд. Таким образом можно решать широкий спектр IT задач от настройки сети до  
установки удалённого доступа, так как устройство фактически может делать всё то же самое что  
и человек в интерфейсе командной строки, но намного быстрее. Поэтому оно хорошо подходит  
для автоматизации задач системного администратора или проверок систем на безопасность.  
  
![outside.jpg](https://github.com/krakrukra/PocketAdmin/blob/master/extra/pictures/photos/outside.jpg)  
![inside.jpg](https://github.com/krakrukra/PocketAdmin/blob/master/extra/pictures/photos/inside.jpg)  
  
Вот короткий список характеристик, которыми PocketAdmin отличается от других badusb устройств:  
  
1. Сделан из недорогих и доступных к покупке деталей, с открытыми исходными файлами, в том  
числе схемой и печатной платой. Это позволяет всем желающим делать значительные изменения в  
устройсте и при желании производить их самостоятельно.  
  
2. Устройство имеет встроенный интерпретатор команд (совместимый с ducky script 1.0), который  
читает команды напрямую в текстовом формате, что убирает необходимость устанавливать  
дополнительное ПО, например для преобразования payload.txt в inject.bin  
  
3. Имеется возможность работы как USB диск, что позволяет делать более полезные скрипты. Чип памяти  
встроен в плату, так что вам не придётся постоянно вставлять/доставать SD карту при разработке.  
  
4. Имеется возможность определения ОС, что позволяет сохранять сразу несколько скриптов работающих  
при подключении. Устройство само может выбрать подходящий для каждой ОС рабочий скрипт.  
  
5. Можно сохранить 17 дополнительных скриптов выполняемых по запросу. Запускать такие скрипты можно  
нажимая нужное количество раз подряд на клавишу CapsLock. Таким же образом можно облегчить работу  
с устройством, например перезагрузить его в режим USB диска или режим DFU не разбирая при этом корпус.  
  
6. Расширенный набор команд для достижения больших возможностей, например управление мышью, команды  
для зажатия клавиш, динамические задержки, возможность повторять блоки команд; возможность нажимать  
несколько клавиш (не модификаторов) одновременно и отсутствие ограничений на порядок команд в строке  
или ограничения возможных комбинаций клавиш.  
  
7. Есть возможность выбрать разные настройки устройства, без необходимости перепрошивки. Например,  
можно указать значения VID/PID, серийный номер устройства, режим подключения (клавиатура + мышь  
или клавиатура + мышь + USB диск). Можно поменять раскладку клавиатуры, скрыть часть памяти на  
USB диске от доступа ПК, показывать ложное значение ёмкости диска, итд.  
  
**ИНСТРУКЦИЯ ПО ПРИМЕНЕНИЮ ЕСТЬ НА [ВИКИ](https://github.com/krakrukra/PocketAdmin/blob/master/extra/wiki/rus/home.md)**  
  
---
  
## аппаратная часть  
  
проект разработан с использованием KiCad 6.0.11  
изучите pcb файл KiCad для информации по печатной плате  
изучите BOM.txt и sch файл KiCad для информации по деталям  
  
Используется встроенное переферийное устройство USB2.0 full-speed (12Мбит/с),  
а также чип памяти дающий ёмкость в 96МиБ для хранения файлов.  
Измеренная скорость доступа к диску: чтение 800-850КиБ/c, запись 700-750 КиБ/с  
  
На устройстве есть LED индикатор и кнопка. LED индикатор показывает статус флеш  
памяти. Он загорается каждый раз когда устройство читает или записывает информацию  
на USB диске. Для избежания порчи файловой системы рекоммендуется не извлекать  
устройство пока индикатор не потухнет. Кнопка на плате включает за режим MSD-only.  
Обычно рабочий скрипт включается каждый раз при подключении устройства, но если  
заранее нажать эту кнопку и удерживать во время подключения, то рабочий скрипт  
выполняться не будет. Вместо этого устройство будет подключено в режиме USB диска  
и отлючит все функции камуфляжа, независимо от того что написано в config.txt  
  
Полностью собранное устройство имеет размер 59x18x9мм и вес 8 грамм.  
При открывании корпуса будьте аккуратны, чтобы не сломать пластиковые  
штырьки рядом с USB коннектором и на противоположной от него стороне.  
  
Программатор используемый для прошивки устройства - [ST-Link V2](https://www.aliexpress.com/item/1823628996.html)  
Инструкции по сборке и прошивке устройства есть в этом видео:  
[https://www.youtube.com/watch?v=cfud5Dq_w2M](https://www.youtube.com/watch?v=cfud5Dq_w2M)  
  
## прошивка  
  
язык программирования = C  
ПО для прошивки = openocd 0.12.0  
среда разработки = emacs + Makefile  
  
Прошивка разработана на системе debian 11.3 с использованием пакета gcc-arm-none-eabi  
(компилятор, компоновщик, бинарные утилиты) и использует раширения компилятора gcc.  
Она была успешно скомпилирована и протестирована с arm-none-eabi-gcc версии 12.2.1  
  
Имеет зависимость от библиотеки libgcc.a, она содержится в репозитории. Скрипт  
компоновщика, стартовый код, и файлы конфигурации openocd также содержатся в нём.  
  
Файлы usb\_rodata.h, hid\_rodata.h, msd\_rodata.h на самом деле не заголовочные,  
а составные части usb.c, main.c, msd.c соответственно. Они не предназначены для  
включения ни в какие другие файлы.  
  
Для упрощения прошивки можно использовать DFU загрузчик. В репозитории есть dfu  
образ прошивки в файле **/firmware/firmware\_RRNNN.dfu**; название записано в  
таком формате: RR - это версия платы (13 = плата 1.3) , NNN - это версия прошивки.  
Например, firmware\_13005.dfu это файл для платы версии 1.3 с прошивкой версии 5.  
  
  
Для автоматизации процесса компиляции применяется утилита make. Если вы откроете  
командную строку в каталоге **/firmware/** вы сможете запустить эти команды:  
  
> make  
> make upload  
> make dfu  
> make clean  
  
"make" компилирует исходный код и создает несколько файлов, среди которых  
есть firmware.bin который и нужно записать в память устройства. "make upload"  
через программатор ST-Link V2 запишет этот файл. Для этого нужно заранее  
правильно подключить плату к программатору, а затем и сам программатор к ПК.  
"make dfu" создаёт из firmware.bin образ dfu для загрузчика, который потом  
можно будет использовать для прошивки без программатора. "make clean"  
удалит все временные и промежуточные файлы созданные предыдущими командами.  
  
## содержание каталогов  
  
#### /firmware/ ------------- содержит makefile, скрипт компоновщика, исходный код, промежуточные файлы  
/firmware/cmsis/ ------- заголовочные файлы из CMSIS библиотеки [STM32F0xx standard peripherals](https://www.st.com/content/st_com/en/products/embedded-software/mcus-embedded-software/stm32-embedded-software/stm32-standard-peripheral-libraries/stsw-stm32048.html)  
/firmware/stdlib/ ---------- стандартные статические библиотеки (libgcc.a)  
/firmware/openocd/ ------- стандартные файлы конфигурации для openocd  
/firmware/fatfs/ ---------- библиотека файловой системы [chan fatfs](http://www.elm-chan.org/fsw/ff/00index_e.html) + собственный драйвер W25N01GVZEIG  
/firmware/usb/ ------------ собственный USB стек, реализация устройств MSD и HID классов  
/firmware/main/ ------- основаная программа, таблица адресов прерываний, стартовый код, функции прерывний  
/firmware/dfuse-pack.py ------- скрипт в python для создания .dfu образов прошивки  
/firmware/linkScript.ld ------- специальный скрипт для GNU компоновщика (ld)  
/firmware/Makefile ------- файл используемый утилитой автоматизации GNU make    
/firmware/firmware_13NNN.dfu ------ заранее скомпилированный образ прошивки в формате DfuSe (STM32)  
  
#### /hardware/ ------------------- содержит KiCad проект, файлы схемы и печатной платы  
/hardware/PocketAdmin.symbols/ -- библиотека символов для схемы проекта  
/hardware/PocketAdmin.pretty/ --- библиотека деталей для платы проекта  
/hardware/gerbers/ ----------- gerber+excellon файлы для производства  
/hardware/BOM.txt --------- список деталей для самостоятельной закупки и сборки  
  
#### /extra/ -------------------  содержит картинки, примеры скриптов, документы, итд.  
/extra/pictures/ ---------------- фото и чертежи механических деталей  
/extra/wiki/ ------------------ страницы вики для github  
/extra/payloads/ ----------- примеры рабочих скриптов для PocketAdmin  
/extra/payloads/fingerprinterTest/fingerdb/ -- образец базы данных отпечатков ОС  
/extra/payloads/layoutTest/kblayout/ --- файлы раскладок клавиатуры  
  
## контактная информация  
  
Если у вас есть проблема / вопрос / предложение, то вот несколько способов связаться со мной:  
отправьте email на krakrukra@tutanota.com  
создайте новый вопрос на github (сначала проверьте [уже закрытые](https://github.com/krakrukra/PocketAdmin/issues?q=is%3Aissue+is%3Aclosed))  
также можно использовать мой [канал на youtube](https://www.youtube.com/channel/UC8HZCV1vNmZvp7ci1vNmj7g)  
  
#### где купить:  
  
Купить можно напрямую связавшись со мной (например через email) или через авито:  
https://www.avito.ru/voronezh/tovary_dlya_kompyutera/virtualnaya_klaviatura_pocketadmin_2844411885  
  